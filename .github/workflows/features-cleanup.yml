name: Cleanup Feature Images

on:
  pull_request:
    types: [closed]
    branches: [ trunk ]

jobs:
  cleanup:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'DSLA-')
    name: Delete Feature Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Extract Branch Name
        id: branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          CLEAN_BRANCH_NAME=${BRANCH_NAME#DSLA-}
          echo "clean_branch_name=$CLEAN_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Cleaning up images for feature branch: $CLEAN_BRANCH_NAME"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Delete Feature Images from Docker Hub
        run: |
          echo "Deleting feature image: ${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater:feature-${{ steps.branch.outputs.clean_branch_name }}"

          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.DOCKERHUB_TOKEN }}" \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater/tags/feature-${{ steps.branch.outputs.clean_branch_name }}/" \
            || echo "Failed to delete main feature tag (might not exist)"

          TAGS_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.DOCKERHUB_TOKEN }}" \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater/tags/?page_size=100")

          echo "$TAGS_RESPONSE" | jq -r '.results[] | select(.name | startswith("feature-'${{ steps.branch.outputs.clean_branch_name }}'-")) | .name' | while read tag; do
            echo "Deleting SHA-tagged image: ${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater:$tag"
            curl -X DELETE \
              -H "Authorization: Bearer ${{ secrets.DOCKERHUB_TOKEN }}" \
              "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater/tags/$tag/" \
              || echo "Failed to delete SHA tag: $tag"
          done

      - name: Confirm Cleanup
        run: |
          echo "‚úÖ Successfully cleaned up Docker images for feature branch: ${{ steps.branch.outputs.clean_branch_name }}"
          echo "üóëÔ∏è Deleted tags:"
          echo "   - feature-${{ steps.branch.outputs.clean_branch_name }}"
          echo "   - feature-${{ steps.branch.outputs.clean_branch_name }}-* (SHA tags)"