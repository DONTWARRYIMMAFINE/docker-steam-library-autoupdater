name: Cleanup Feature Images

on:
  pull_request:
    types: [closed]
    branches: [ trunk ]

jobs:
  cleanup:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'DSLA-')
    name: Delete Feature Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Extract Branch Name
        id: branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          CLEAN_BRANCH_NAME=${BRANCH_NAME#DSLA-}
          echo "clean_branch_name=$CLEAN_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Cleaning up images for feature branch: $CLEAN_BRANCH_NAME"

      - name: Get Docker Hub JWT Token
        id: dockerhub_auth
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{"username": "${{ vars.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            "https://hub.docker.com/v2/users/login/")
          
          TOKEN=$(echo $RESPONSE | jq -r '.token')
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "Failed to get Docker Hub token"
            echo "Response: $RESPONSE"
            exit 1
          fi
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "Successfully obtained Docker Hub token"

      - name: Delete Feature Image from Docker Hub
        run: |
          IMAGE_TAG="feature-${{ steps.branch.outputs.clean_branch_name }}"
          echo "Deleting feature image: ${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater:$IMAGE_TAG"

          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${{ steps.dockerhub_auth.outputs.token }}" \
            "https://hub.docker.com/v2/repositories/${{ vars.DOCKERHUB_USERNAME }}/steam-library-autoupdater/tags/$IMAGE_TAG/")
          
          if [ "$RESPONSE" -eq 204 ]; then
            echo "‚úÖ Successfully deleted feature image: $IMAGE_TAG"
          elif [ "$RESPONSE" -eq 404 ]; then
            echo "‚ö†Ô∏è Image tag not found: $IMAGE_TAG (might have been already deleted)"
          else
            echo "‚ùå Failed to delete image tag. HTTP status: $RESPONSE"
            cat response.txt
            echo ""
          fi

      - name: Verify Deletion
        run: |
          echo "‚úÖ Cleanup completed for feature branch: ${{ steps.branch.outputs.clean_branch_name }}"
          echo "üóëÔ∏è Deleted tag: feature-${{ steps.branch.outputs.clean_branch_name }}"